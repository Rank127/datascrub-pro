generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String             @id @default(cuid())
  email                  String             @unique
  passwordHash           String
  name                   String?
  plan                   String             @default("FREE")
  emailVerified          DateTime?
  image                  String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  emailNotifications     Boolean            @default(true)
  marketingEmails        Boolean            @default(false)
  newExposureAlerts      Boolean            @default(true)
  removalUpdates         Boolean            @default(true)
  reportFrequency        String             @default("weekly")
  weeklyReports          Boolean            @default(true)
  role                   String             @default("USER")
  lastExposureDigestSent DateTime?
  lastScanAt             DateTime?
  smsBreachAlerts        Boolean            @default(true)
  smsExposureAlerts      Boolean            @default(true)
  smsNotifications       Boolean            @default(false)
  smsPhone               String?
  smsPhoneVerified       Boolean            @default(false)
  smsRemovalUpdates      Boolean            @default(true)
  twoFactorBackupCodes   String?
  twoFactorEnabled       Boolean            @default(false)
  twoFactorSecret        String?
  accounts               Account[]
  auditLogs              AuditLog[]
  dripCampaign           DripCampaign?
  dripEmailLogs          DripEmailLog[]
  exposures              Exposure[]
  ownedFamilyGroup       FamilyGroup?       @relation("FamilyOwner")
  sentFamilyInvites      FamilyInvitation[] @relation("SentFamilyInvitations")
  familyMembership       FamilyMember?
  profiles               PersonalProfile[]
  referredBy             Referral?          @relation("ReferredBy")
  referralsMade          Referral[]         @relation("Referrals")
  removalRequests        RemovalRequest[]
  scans                  Scan[]
  sessions               Session[]
  subscription           Subscription?
  assignedTickets        SupportTicket[]    @relation("AssignedTickets")
  resolvedTickets        SupportTicket[]    @relation("ResolvedTickets")
  tickets                SupportTicket[]    @relation("UserTickets")
  ticketComments         TicketComment[]
  whitelists             Whitelist[]

  @@index([createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PersonalProfile {
  id          String   @id @default(cuid())
  userId      String
  fullName    String?
  aliases     String?
  emails      String?
  phones      String?
  addresses   String?
  dateOfBirth String?
  ssnHash     String?
  photoUrls   String?
  usernames   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Scan {
  id             String     @id @default(cuid())
  userId         String
  status         String     @default("PENDING")
  type           String
  exposuresFound Int        @default(0)
  sourcesChecked Int        @default(0)
  progress       Int        @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime   @default(now())
  exposures      Exposure[]
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Exposure status values:
// ACTIVE - Exposure is active and visible
// REMOVAL_PENDING - Waiting for removal to be processed
// REMOVAL_IN_PROGRESS - Removal request has been sent
// REMOVED - Data has been removed from the source
// MONITORING - Being monitored but no removal action needed
// FALSE_POSITIVE - Broker confirmed user's data is not in their system (NEW)
model Exposure {
  id                   String          @id @default(cuid())
  userId               String
  scanId               String?
  source               String
  sourceUrl            String?
  sourceName           String
  dataType             String
  dataPreview          String?
  severity             String
  status               String          @default("ACTIVE")
  isWhitelisted        Boolean         @default(false)
  firstFoundAt         DateTime        @default(now())
  lastSeenAt           DateTime        @default(now())
  manualActionTaken    Boolean         @default(false)
  manualActionTakenAt  DateTime?
  requiresManualAction Boolean         @default(false)
  proofScreenshot      String?
  proofScreenshotAt    DateTime?
  // Confidence scoring fields
  confidenceScore      Int?            // 0-100 confidence score
  confidenceFactors    String?         // JSON: { nameMatch, locationMatch, ageMatch, dataCorrelation, sourceReliability }
  matchClassification  String?         // CONFIRMED, LIKELY, POSSIBLE, UNLIKELY
  confidenceReasoning  String?         // JSON array of reasoning strings
  validatedAt          DateTime?       // When confidence was calculated
  userConfirmed        Boolean         @default(false) // User manually confirmed this is their data
  userConfirmedAt      DateTime?       // When user confirmed
  // Precision tracking fields (NEW)
  factorsMatched       Int?            // Number of confidence factors that matched (2+ required)
  markedFalsePositive  Boolean         @default(false) // User or broker marked as false positive
  falsePositiveReason  String?         // Why this was marked false positive
  falsePositiveAt      DateTime?       // When marked false positive
  scan                 Scan?           @relation(fields: [scanId], references: [id])
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  removalRequest       RemovalRequest?

  @@index([userId])
  @@index([scanId])
  @@index([userId, requiresManualAction])
  @@index([userId, userConfirmed])
  @@index([userId, status])
  @@index([userId, isWhitelisted])
  @@index([confidenceScore])
  @@index([markedFalsePositive])
}

model Whitelist {
  id         String   @id @default(cuid())
  userId     String
  source     String
  sourceUrl  String?
  sourceName String
  reason     String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, source])
}

model RemovalRequest {
  id                 String    @id @default(cuid())
  userId             String
  exposureId         String    @unique
  status             String    @default("PENDING")
  method             String
  submittedAt        DateTime?
  completedAt        DateTime?
  attempts           Int       @default(0)
  lastError          String?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastVerifiedAt     DateTime?
  verificationCount  Int       @default(0)
  verifyAfter        DateTime?
  afterScreenshot    String?
  afterScreenshotAt  DateTime?
  beforeScreenshot   String?
  beforeScreenshotAt DateTime?
  formScreenshot     String?
  formScreenshotAt   DateTime?
  isProactive        Boolean   @default(false)
  exposure           Exposure  @relation(fields: [exposureId], references: [id])
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([status])
  @@index([verifyAfter])
}

model Subscription {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  plan                   String    @default("FREE")
  status                 String    @default("active")
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Alert {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  metadata  String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model DNCRegistration {
  id           String    @id @default(cuid())
  userId       String
  phoneNumber  String
  phoneHash    String
  status       String    @default("PENDING")
  registeredAt DateTime?
  verifiedAt   DateTime?
  expiresAt    DateTime?
  phoneType    String    @default("UNKNOWN")
  attempts     Int       @default(0)
  lastError    String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  phoneLast4   String?

  @@unique([userId, phoneHash])
  @@index([userId])
  @@index([status])
}

model CustomRemovalRequest {
  id               String    @id @default(cuid())
  userId           String
  targetUrl        String
  siteName         String?
  dataType         String
  dataPreview      String?
  status           String    @default("PENDING")
  priority         String    @default("NORMAL")
  assignedToId     String?
  assignedAt       DateTime?
  userNotes        String?
  internalNotes    String?
  resolution       String?
  attempts         Int       @default(0)
  lastAttemptAt    DateTime?
  lastError        String?
  userScreenshot   String?
  beforeScreenshot String?
  afterScreenshot  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  completedAt      DateTime?

  @@index([userId])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  actorId      String
  actorEmail   String
  actorRole    String
  action       String
  resource     String
  resourceId   String?
  targetUserId String?
  targetEmail  String?
  ipAddress    String?
  userAgent    String?
  details      String?
  success      Boolean  @default(true)
  errorMessage String?
  createdAt    DateTime @default(now())
  actor        User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
}

model EmailQueue {
  id          String    @id @default(cuid())
  toEmail     String
  subject     String
  htmlContent String
  emailType   String
  priority    Int       @default(5)
  userId      String?
  context     String?
  status      String    @default("QUEUED")
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processAt   DateTime  @default(now())
  sentAt      DateTime?

  @@index([status])
  @@index([processAt])
  @@index([emailType])
  @@index([userId])
}

model SupportTicket {
  id               String          @id @default(cuid())
  ticketNumber     String          @unique
  userId           String
  type             String
  status           String          @default("OPEN")
  priority         String          @default("NORMAL")
  subject          String
  description      String
  source           String          @default("USER")
  scanId           String?
  exposureId       String?
  removalRequestId String?
  subscriptionId   String?
  assignedToId     String?
  assignedAt       DateTime?
  resolution       String?
  resolvedAt       DateTime?
  resolvedById     String?
  internalNotes    String?
  lastActivityAt   DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  attachments      String?
  browserInfo      String?
  errorDetails     String?
  pageUrl          String?
  assignedTo       User?           @relation("AssignedTickets", fields: [assignedToId], references: [id])
  resolvedBy       User?           @relation("ResolvedTickets", fields: [resolvedById], references: [id])
  user             User            @relation("UserTickets", fields: [userId], references: [id], onDelete: Cascade)
  comments         TicketComment[]

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([type])
  @@index([createdAt])
}

model TicketComment {
  id         String        @id @default(cuid())
  ticketId   String
  authorId   String
  content    String
  isInternal Boolean       @default(false)
  createdAt  DateTime      @default(now())
  author     User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model FamilyGroup {
  id          String             @id @default(cuid())
  ownerId     String             @unique
  name        String?
  maxMembers  Int                @default(5)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  owner       User               @relation("FamilyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  invitations FamilyInvitation[]
  members     FamilyMember[]
}

model FamilyMember {
  id            String      @id @default(cuid())
  familyGroupId String
  userId        String      @unique
  role          String      @default("MEMBER")
  joinedAt      DateTime    @default(now())
  familyGroup   FamilyGroup @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyGroupId])
}

model FamilyInvitation {
  id            String      @id @default(cuid())
  familyGroupId String
  email         String
  token         String      @unique
  status        String      @default("PENDING")
  invitedById   String
  expiresAt     DateTime
  createdAt     DateTime    @default(now())
  acceptedAt    DateTime?
  familyGroup   FamilyGroup @relation(fields: [familyGroupId], references: [id], onDelete: Cascade)
  invitedBy     User        @relation("SentFamilyInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([familyGroupId, email])
  @@index([token])
  @@index([email])
}

model CronLog {
  id        String   @id @default(cuid())
  jobName   String
  status    String
  duration  Int?
  message   String?
  metadata  String?
  createdAt DateTime @default(now())

  @@index([jobName])
  @@index([createdAt])
  @@index([jobName, createdAt])
}

model AgentExecution {
  id               String    @id @default(cuid())
  agentId          String
  capability       String
  requestId        String    @unique
  invocationType   String
  status           String
  input            String?
  output           String?
  error            String?
  confidence       Float?
  needsHumanReview Boolean   @default(false)
  startedAt        DateTime
  completedAt      DateTime?
  duration         Int?
  tokensUsed       Int?
  model            String?
  usedFallback     Boolean   @default(false)
  parentRequestId  String?
  correlationId    String?
  createdAt        DateTime  @default(now())

  @@index([agentId])
  @@index([agentId, createdAt])
  @@index([status])
  @@index([invocationType])
  @@index([parentRequestId])
  @@index([correlationId])
  @@index([createdAt])
}

model AgentHealth {
  id                  String    @id @default(cuid())
  agentId             String    @unique
  status              String
  lastRun             DateTime?
  lastSuccess         DateTime?
  lastFailure         DateTime?
  consecutiveFailures Int       @default(0)
  successRate24h      Float?
  avgExecutionTime    Int?
  aiAvailable         Boolean   @default(true)
  errorMessage        String?
  executions24h       Int       @default(0)
  successes24h        Int       @default(0)
  failures24h         Int       @default(0)
  tokensUsed24h       Int       @default(0)
  estimatedCost24h    Float     @default(0)
  avgConfidence       Float?
  humanReviewRate     Float?
  updatedAt           DateTime  @updatedAt
  createdAt           DateTime  @default(now())

  @@index([status])
  @@index([lastRun])
}

model AgentConfig {
  id           String   @id @default(cuid())
  agentId      String   @unique
  enabled      Boolean  @default(true)
  model        String?
  maxTokens    Int?
  temperature  Float?
  rateLimits   String?
  retryConfig  String?
  features     String?
  customConfig String?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([enabled])
}

model AgentEvent {
  id            String    @id @default(cuid())
  eventId       String    @unique
  type          String
  sourceAgentId String
  targetAgentId String?
  payload       String?
  correlationId String?
  timestamp     DateTime  @default(now())
  processed     Boolean   @default(false)
  processedAt   DateTime?

  @@index([type])
  @@index([sourceAgentId])
  @@index([targetAgentId])
  @@index([correlationId])
  @@index([timestamp])
  @@index([processed])
}

model WorkflowExecution {
  id            String    @id @default(cuid())
  workflowId    String
  requestId     String    @unique
  status        String
  currentStep   Int       @default(0)
  totalSteps    Int
  stepResults   String?
  input         String?
  output        String?
  error         String?
  startedAt     DateTime
  completedAt   DateTime?
  duration      Int?
  tokensUsed    Int       @default(0)
  agentsInvoked Int       @default(0)
  usedFallbacks Boolean   @default(false)
  executionPath String?
  createdAt     DateTime  @default(now())

  @@index([workflowId])
  @@index([status])
  @@index([createdAt])
}

model KeywordIntelligence {
  id           String   @id @default(cuid())
  keyword      String   @unique
  source       String
  relevance    Int
  searchVolume String?
  difficulty   String?
  timesFound   Int      @default(1)
  competitor   String?
  isTargeted   Boolean  @default(false)
  firstSeen    DateTime @default(now())
  lastSeen     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([source])
  @@index([relevance])
  @@index([isTargeted])
  @@index([lastSeen])
}

model KeywordResearchRun {
  id                  String   @id @default(cuid())
  searchEnginesUsed   String
  keywordsDiscovered  Int
  keywordGaps         Int
  competitorsAnalyzed Int
  duration            Int
  status              String   @default("COMPLETED")
  error               String?
  createdAt           DateTime @default(now())

  @@index([createdAt])
  @@index([status])
}

model DripCampaign {
  id           String   @id @default(cuid())
  userId       String   @unique
  enrolledAt   DateTime @default(now())
  nextEmailDay Int      @default(0)
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([enrolledAt])
}

model DripEmailLog {
  id         String   @id @default(cuid())
  userId     String
  templateId String
  sentAt     DateTime @default(now())
  opened     Boolean  @default(false)
  clicked    Boolean  @default(false)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateId])
  @@index([sentAt])
}

model Referral {
  id             String    @id @default(cuid())
  referrerId     String
  referredUserId String?   @unique
  referralCode   String    @unique
  status         String    @default("pending")
  rewardAmount   Int       @default(0)
  createdAt      DateTime  @default(now())
  convertedAt    DateTime?
  referredUser   User?     @relation("ReferredBy", fields: [referredUserId], references: [id])
  referrer       User      @relation("Referrals", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
  @@index([status])
}

model EntityClassification {
  id                 String    @id @default(cuid())
  domain             String
  classification     String
  confidence         Float
  source             String
  reasoning          String
  parentCompany      String?
  blockedFromRemoval Boolean   @default(false)
  requestId          String?
  verifiedBy         String?
  verifiedAt         DateTime?
  expiresAt          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([domain])
  @@index([classification])
  @@index([createdAt])
  @@index([domain, createdAt])
}

model ComplianceComplaint {
  id                      String    @id @default(cuid())
  senderEmail             String
  senderName              String?
  senderCompany           String?
  subject                 String
  complaintType           String
  severity                String
  requiresImmediateAction Boolean   @default(false)
  keyPoints               String?
  requestedActions        String?
  mentionedEntities       String?
  legalReferences         String?
  threats                 String?
  deadlines               String?
  rawContent              String?
  parsedAt                DateTime  @default(now())
  inboxType               String?
  requestId               String?
  status                  String    @default("PENDING")
  resolvedAt              DateTime?
  resolvedBy              String?
  resolution              String?
  ticketId                String?
  entityClassificationId  String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@index([senderEmail])
  @@index([complaintType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

model BlocklistAuditLog {
  id               String   @id @default(cuid())
  domain           String
  companyName      String?
  action           String
  reason           String
  previousValue    String?
  newValue         String?
  actorType        String
  actorId          String?
  actorEmail       String?
  complaintId      String?
  classificationId String?
  ticketId         String?
  requestId        String?
  ipAddress        String?
  userAgent        String?
  notes            String?
  createdAt        DateTime @default(now())

  @@index([domain])
  @@index([action])
  @@index([actorId])
  @@index([createdAt])
  @@index([domain, createdAt])
}

// Track broker intelligence for precision improvement
// This helps identify brokers with high false positive rates
model BrokerIntelligence {
  id                  String   @id @default(cuid())
  source              String   @unique  // Broker source key (e.g., "SPOKEO")
  sourceName          String?           // Human-readable name
  // Counts for calculating rates
  totalExposures      Int      @default(0) // Total exposures created for this broker
  truePositiveCount   Int      @default(0) // User confirmed or successfully removed
  falsePositiveCount  Int      @default(0) // Broker said "not found" or user said "not me"
  removalsSent        Int      @default(0) // Total removal requests sent
  removalsCompleted   Int      @default(0) // Removals confirmed completed
  // Calculated rates (updated periodically)
  falsePositiveRate   Float    @default(0) // falsePositiveCount / totalExposures
  successRate         Float    @default(50) // removalsCompleted / removalsSent
  // Metadata
  lastExposureAt      DateTime?
  lastRemovalAt       DateTime?
  lastFalsePositiveAt DateTime?
  notes               String?
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([source])
  @@index([falsePositiveRate])
  @@index([successRate])
}

// Strategic directives generated by Mastermind weekly board meetings
// Agents and crons read these to adjust thresholds, batch sizes, and strategies
model StrategicDirective {
  id            String   @id @default(cuid())
  category      String   // "removal", "content", "seo", "support", "billing", "growth", "competitive-intel", "global"
  key           String   // e.g., "removal_batch_pending", "seo_target_readability"
  value         Json     // Number, string, array, or object
  rationale     String   // Why this directive was set
  advisorSource String?  // Which advisor(s) influenced this
  source        String   // "mastermind-weekly", "admin-manual", "board-meeting"
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([category, key])
  @@index([category, isActive])
  @@index([isActive])
}
